# プリミティブフィッティング 仕様解説（わかりやすい版）

## これは何をするツール？
LiDAR 点群（XYZ）から、ユーザが指定した「それっぽい領域」に対して
**平面**または**円柱**のプリミティブを当てはめ、形状パラメータを推定する
半自動の研究用プロトタイプです。取得済み点群（SLAM後など）を**オフラインで解析**する用途を想定しています。

## 想定環境
- Ubuntu（GUI が動く Linux デスクトップ）
- Python 3.8+
- Open3D / NumPy

## 入力
- `--input` で PCD / PLY の点群ファイルを指定
- RGB があっても v0 では **XYZ のみ使用**

## 基本の処理フロー
1. **前処理**
   - ダウンサンプリング（`--voxel_size`）
   - 外れ値除去（統計的）
   - 法線推定
2. **ROI 選択（半自動）**
   - Open3D ビューワで点群を表示
   - Shift+クリックで中心を指定し、半径 `--roi_radius` 近傍を ROI にする
3. **プリミティブ選択**
   - ROI に対して **平面**または **円柱** を選ぶ
4. **フィッティング**
   - 平面: RANSAC で平面推定（法線・平面上の点・インライヤ数）
   - 円柱: ROI と法線から円柱を推定（軸・半径・長さ・インライヤ数）
5. **可視化**
   - Open3D でフィット結果をオーバーレイ表示
6. **保存**
   - JSON に結果を追記保存（デフォルト `fit_results.json`）

## 設計ロジック（なぜこの構成か）
### 入力・前提
- **XYZ のみを使う理由**: センサや SLAM パイプラインによって RGB が欠落することが多く、まずは幾何のみで成立する最小構成を優先。
- **オフライン前提**: LIO/SLAM 後の点群を対象にし、リアルタイム性より再現性と検証のしやすさを重視。

### 前処理
- **ダウンサンプリング**: 点数を抑えて計算を軽くしつつ、形状の大域的な傾向は残すため。
- **外れ値除去**: 反射ノイズや飛び点が RANSAC を壊しやすいため、早い段階で除去。
- **法線推定**: 円柱フィットでは軸方向推定に寄与し、平面でも安定した推定に役立つ。

### ROI 選択（半自動）
- **完全自動を避ける理由**: 実環境点群は不要物が多く、ユーザが「狙い」を軽く指定できる方が精度と操作性のバランスが良い。
- **Shift+クリック + 半径方式**: 実装が簡単で、UI 依存が少なく、再現性のある操作が可能。

### プリミティブ選択
- **平面 / 円柱のみに限定**: 工場・建築物などで出現頻度が高く、寸法推定にも直結するため。
- **ユーザ選択式**: 自動分類の誤判定より、作業者の意図を優先する方が確実。

### フィッティング
- **RANSAC を採用**: 外れ値に強く、ROI が多少汚れていても安定して推定できるため。
- **円柱の長さ算出**: インライヤを軸方向に投影することで、視線方向に依存しない長さ評価が可能。

### 可視化
- **Open3D に統一**: 点群表示とフィット結果の重ね描画を同一ツールで完結でき、開発コストが低い。
- **オーバーレイ表示**: 成否の判断を即時に行えるため、試行回数を減らせる。

### 保存形式（JSON）
- **構造が単純で拡張可能**: 研究用途での後処理（解析・可視化）に適し、項目追加にも強い。
- **追記保存**: 同一セッションで複数フィットを溜められる運用を想定。

### 階段モード
- **水平面の反復抽出**: 階段は「複数の水平面」という構造で説明できるため、単純な反復 RANSAC が効く。
- **高さマージ**: 同一段の面が複数に分割されるのを抑え、段数推定を安定化させる。
- **パラメータ露出**: センサやスケールに応じて閾値を調整できるよう、制御性を優先。

## 出力（標準モード）
- 例（`fit_results.json`）:

```json
{
  "planes": [
    {
      "id": 0,
      "normal": [0.0, 0.0, 1.0],
      "point": [1.0, 2.0, 0.5],
      "inlier_count": 150
    }
  ],
  "cylinders": [
    {
      "id": 0,
      "axis_point": [0.0, 0.0, 0.0],
      "axis_direction": [0.0, 0.0, 1.0],
      "radius": 0.05,
      "length": 1.2,
      "inlier_count": 200
    }
  ]
}
```

## 階段モード（stairs mode）
階段の踏面や踊り場のような**水平面を複数枚自動抽出**するモードです。
- `--stairs-mode` を付けて実行
- ROI 内から水平に近い平面を連続で抽出
- 結果は `stairs_results.json` に保存
- `--export-mesh` で平面メッシュ（PLY/OBJ）も出力可能

### 主要オプション例
- `--max-planes` : 抽出する最大平面数
- `--min-inliers` : 平面とみなす最小点数
- `--max-tilt` : 水平とみなす傾斜角の上限
- `--height-eps` : 高さで平面をマージする許容値

## コマンドラインの要点
- `--input`（必須）: 入力点群
- `--voxel_size` : 前処理のダウンサンプリング間隔
- `--no_preprocess` : 前処理をスキップ
- `--output` : 標準モードの出力 JSON
- `--stairs-mode` : 階段モード有効化

## この仕様の狙い
- **完全自動ではなく、素早く試せる半自動**を優先
- 研究用途として、**シンプルで拡張しやすい構成**を重視
- 円柱フィッタや色利用など、将来拡張がしやすい設計を目指す

---

必要なら、この解説をベースに「詳しめの仕様書」や「操作マニュアル」版も作れます。
