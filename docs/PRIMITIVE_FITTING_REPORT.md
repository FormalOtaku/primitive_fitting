# Primitive Fitting GUI 報告資料（概要＋ロジック詳細）

## 1. ソフトウェア概要
本ソフトは、点群から**平面・円柱（＋階段）**といった幾何プリミティブを**インタラクティブに抽出**する研究用GUIです。ユーザが点群内の**ROI（目安領域）**や**seed**を指定し、アルゴリズムがその領域内の点群から最適なプリミティブを推定します。用途としては工場・構内など、**柱や床・壁などの構造物**の幾何推定を想定しています。

- 入力: PLY/PCD 点群
- 出力: JSON（検出結果）、メッシュ（視覚化）
- 操作: Open3D GUIでROI/seed指定、パラメータ調整

<!-- 画像挿入: ソフト全体のGUIスクリーンショット（右パネル・点群・ROI・結果円柱が見えるもの） -->

## 2. 主要機能
- **ROI指定＋seed指定**による局所推定
- **平面推定**（RANSAC + seed拡張）
- **円柱推定**（ROI内推定 + 高度化ロジック）
- **地面・天井平面の制約**（円柱の長さ・傾きを安定化）
- **アウトライナー**で可視化メッシュ管理
- **編集モード**で点群削除（研究用途）

## 3. 全体フロー（ユーザ視点）
1. 点群を読み込み
2. ROI（円柱/箱）をざっくり置く or Shift+クリックでseed指定
3. モード選択（平面/円柱）
4. 実行
5. 結果をアウトライナーで確認／保存

<!-- 画像挿入: ROI円柱を指定して実行した例（ROIと結果が同時に見える） -->

## 4. 平面推定ロジック（概要）
平面推定は**seed周辺から局所的に開始し、徐々に拡張**する方式です。

### 4.1 処理の流れ
- **seed周辺の点群**を取得
- seed領域で**RANSAC平面推定**
- 初期平面から**近傍点を拡張**（閾値で判定）
- 拡張点で平面を**再フィット**
- 必要に応じて**パッチメッシュ**生成

### 4.2 重要パラメータ
- 平面距離閾値（plane_threshold）
- 法線角度閾値（normal_th）
- 最大拡張半径（max_expand_radius）
- 最大拡張点数・ステップ数

<!-- 画像挿入: 平面抽出の結果（床や壁の平面メッシュが見える） -->

## 5. 円柱推定ロジック（最新・高度化版）
円柱推定は**ROI内の点群を使った局所推定**を基本とし、以下の強化を入れています。

### 5.1 ROIは「目安」であり軸は点群から推定
- ROIは「この範囲内の点を使って推定してほしい」という目安
- 軸はROIではなく**点群の統計から推定**

### 5.2 高度化された円柱推定フロー
1. **ROIで点群を絞り込み**
2. **地面近傍の点を除去**（地面推定がある場合）
3. **円柱表面近傍にさらに絞り込み**
   - ROI半径±マージン内の点だけ残す
4. **軸の候補を複数生成**
   - 法線分布から推定した軸
   - PCA由来軸
   - ROI軸（あくまで候補）
   - 地面法線
   - ランダムサブセットPCA軸
5. **候補ごとに円柱をフィット**
6. **スコア最大の軸を採用**
   - inlier数 / 残差中央値
7. **最終円柱を確定**

### 5.3 「ROI高速モード」
ROIが大きくて落ちる場合に備え、
**ROI内で高速推定して完結**するモードを用意。
BFS拡張を回避し、安定性を優先。

### 5.4 地面・天井制約
- **地面平面**を指定すると、円柱軸が垂直方向に寄りやすくなる
- **天井平面**がある場合は長さを確定
- **地面のみ**の場合、ROI高さを最低長さとして補正

<!-- 画像挿入: ROI円柱（白）と推定結果（ピンク）の比較 -->

## 6. 計算効率と安定性対策
- **自動サンプリング**: 点群が大きすぎる場合は上限点数に切り詰め
- **ROI高速モード**: BFS展開を回避
- **GPU前処理**: 法線推定などをCUDAで加速
- **パラメータの自動調整**: 直径/高さ入力に基づき閾値・拡張半径を調整

<!-- 画像挿入: 自動サンプリングON/OFFの比較（処理時間や安定性の差） -->

## 7. 失敗しやすい条件と対処
- **床や壁がROIに混入** → 地面除去ON、ROIを絞る
- **点群が疎** → voxelサイズを小さくする、法線半径を大きく
- **柱が傾いて推定される** → 垂直制約ON、地面推定ON
- **高さが短い** → 天井制約ON or ROI高さ補正

## 8. 現状のソフトの特徴
- **インタラクティブにROIを置きながら推定できる**
- **点群の粗さやノイズがあっても、ROIで局所推定が可能**
- **地面・天井制約が入ることで安定化**
- **大規模点群にも耐える工夫（サンプリング/高速モード）**

<!-- 画像挿入: 入力点群がノイジーでも抽出できた例 -->

## 9. 研究的意義（簡易まとめ）
- 従来の自動抽出に比べて**少ない操作で高精度の局所推定**が可能
- **人間の直感（ROI）＋自動推定（RANSAC/PCA/法線統計）**の融合
- 工場環境など**円柱・平面が混在する環境に適用可能**

---

## 付録: 実装の要点（関数単位）
- `probe_cylinder_from_seed`: seedベースの円柱推定パイプライン
- `fit_cylinder`: RANSAC円柱フィット
- `fit_cylinder_with_axis`: 軸固定で円柱フィット
- `expand_cylinder_from_seed`: seed展開＋再フィット
- `expand_plane_from_seed`: 平面拡張
- `extract_stair_planes`: 階段抽出
- `recompute_cylinder_length_from_inliers`: 長さ補正

<!-- 画像挿入: 実装フロー図（関数呼び出しの流れ） -->
