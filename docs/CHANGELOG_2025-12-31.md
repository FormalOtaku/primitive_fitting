# 変更差分まとめ（2025-12-31）

## 概要
円柱フィッティングの安定化・高速化・UI改善（Claude案の主要部分を統合）

- **primitives.py**: ロバスト軸推定、中心重みサンプリング、長さ推定の改善
- **gui_app.py**: 円柱プリセット、ROI推定の軸候補強化、Shift判定の互換対応、天井/地面拘束の自動ゲート

---

## primitives.py の主な変更

### 1. BFS拡張にタイムアウト制御を追加
- 大規模点群でフリーズしないよう、連結成分拡張にタイムアウトを導入。

### 2. 高さ推定のロバスト化
- 量子化（quantile）だけでなく、IQR / MAD を併用して長さ推定を安定化。
- `min_length` / `expected_length` を考慮可能にし、短すぎる円柱を回避。

### 3. RANSAC的な軸推定を追加
- ランダムサブセットで PCA 軸を複数回推定し、コンセンサス最大の軸を採用。
- 外れ値が混ざるケースに強い。

### 4. 中央重み付きサンプリング
- ROI 中心に近い点を優先してサンプルし、安定な推定に寄与。

### 5. ロバスト軸候補生成
- PCA / RANSAC / 法線 / 垂直バイアス / trimmed PCA を統合して候補生成。
- 候補ごとに信頼度を持たせ、後段のスコアリングに反映。

### 6. compute_cylinder_proxy_from_seed の強化
- ロバスト軸候補を使用して proxy を推定。
- 候補の信頼度でスコアを補正し、安定な軸を選択。

---

## gui_app.py の主な変更

### 1. 円柱プリセットの追加
- 「細い/中くらい/太い/大きな円柱/高精度」プリセットを追加。
- しきい値・成長半径・ROI半径設定がワンクリックで調整可能。

### 2. ROI推定の軸候補を強化
- `robust_axis_from_cylinder_points` を使用し、点群中心からの軸推定が安定。
- ROI軸固定は「固定チェック時のみ」適用（通常は自動推定）。

### 3. Shift判定の互換対応
- CUDAビルド版 Open3D で `event.is_modifier_down` が無い場合でも
  クラッシュせず Shift 操作が継続できるように修正。

### 4. 天井/地面拘束の自動ゲート
- 平面が円柱インライヤ範囲から大きく外れている場合は拘束を無効化。
- 1枚平面のみの場合、長さを強制せず「位置の微調整」に限定。

---

## 追加ノート
- 円柱の傾き問題を軽減するため、ROI軸依存を緩和し、
  点群内部の軸推定を優先する設計へ変更。

